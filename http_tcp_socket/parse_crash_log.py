# Author = 'Vincent FUNG'
# Create = '2017/09/20'
#                       ::
#                      :;J7, :,                        ::;7:
#                      ,ivYi, ,                       ;LLLFS:
#                      :iv7Yi                       :7ri;j5PL
#                     ,:ivYLvr                    ,ivrrirrY2X,
#                     :;r;j5P.7r:                :ivuksxerfnli.
#                    :iL7::,:::iiirii:ii;::::,,irvF7rvvLujL7ur
#                   ri::,:,::i:iiiiiii:i:irrv177JX7rYXqZEkvv17
#                ;i:, , ::::iirrririi:i:::iiir2XXvii;L8OGJr71i
#              :,, ,,:   ,::irii:i:::.irii:i:::j1jri7ZBOS7ivv,
#                 ,::,    ::rv77iiiriii:iii:i::,rvLrYXqZEk.Li
#             ,,      ,, ,:ir7ir::,:::i;ir:::i:i::rSGGYri712:
#           :::  ,v7r:: ::rrv77:, ,, ,:i7rrii:::::, ir7ri7Lri
#          ,     2OBBOi,iiir;r::        ,irriiii::,, ,iv7Luur:
#        ,,     i78MBBi,:,:::,:,  :7FSL: ,iriii:::i::,,:rLqXv::
#        :      iuMMP: :,:::,:ii;Y#LYBB0viiii:i:iii:i:::iJqL;::
#       ,     ::::i   ,,,,, ::LuBBu BBBBBErii:i:i:i:i:i:i:r77ii
#      ,       :       , ,,:::rruBZ1MBBqi, :,,,:::,::::::iiriri:
#     ,               ,,,,::::i:  :i:i:i:i.       ,:,, ,:::ii;i7:
#    :,       rjujLYLi   ,,:::::,:::::::::,,   ,:i,:,,,,,::i:iii
#    ::      BBBBBBBBB0,    ,,::: , ,:::::: ,      ,,,, ,,:::::::
#    i,  ,  ,8@VINCENTBBi     ,,:,,     ,,, , ,   , , , :,::ii::i::
#    :      iZMOMOMBBM2::::::::::,,,,     ,,,,,,:,,,::::i:irr:i:::,
#    i   ,,:;u0MBMOG1L:::i::::::  ,,,::,   ,,, ::::::i:i:iirii:i:i:
#    :    ,iuUuuXUkFu7i:iii:i:::, :,:,: ::::::::i:i:::::iirr7iiri::
#    :     :rkwwiBivf.i:::::, ,:ii:::::::i:::::i::,::::iirrriiiri::,
#     :      5BMBBBBBBSr:,::rv2kuii:::iii::,:i:,, , ,,:,:ia5wf88s5.,
#          , :r50EZ8MILOVEYOUBZP7::::i::,:::::,: :,:,::i;rrririiii::
#              :jujYY7LS0ujJL7r::,::i::,::::::::::::::iirirrrrrrr:ii:
#           ,:  :::,: :,,:,,,::::i:i:::::::::::,,:::::iir;ii;7v7;ii;i,
#           ,,,     ,,:,::::::i:iiiii:i::::,, ::::iiiii;L8OGJrf.r;7:i,
#        , , ,,,:,,::::::::iiiiiiiiii:,:,:::::::::iiir;ri7vL77rrirri::
#         :,, , ::::::::i:::i:::i:i::,,,,,:,::i:i:::iir;:::i:::i:ii:::
#                          _
#                      o _|_           __
#                      |  |      (__| (__) (__(_
#                                   |

import subprocess
import re
from http_tcp_socket import subproc


class CrashParser:
    def __init__(self, cleardata, stacktrac, atospase, packagenames, curname):
        self.nStacktrace_max = 0
        self.stacktrac_list = stacktrac
        self.data_lines = cleardata
        self.parse_lines = atospase
        self.package_names = packagenames
        self.cur_app_name = curname
        self.version_number = str()
        self.build_number = str()
        self.proc = subproc.SubProcessBase()
        self.request_raw = b'POST / HTTP/1.1\r\ncache-control: no-cache\r\nPostman-Token: 188e7454-9e78-401e-a935-3c08b7b6591a\r\nContent-Type: text/plain\r\nUser-Agent: PostmanRuntime/6.3.2\r\nAccept: */*\r\nHost: 127.0.0.1:8000\r\naccept-encoding: gzip, deflate\r\ncontent-length: 5074\r\nConnection: keep-alive\r\n\r\n{"data":"=============\xe5\xbc\x82\xe5\xb8\xb8\xe5\xb4\xa9\xe6\xba\x83\xe6\x8a\xa5\xe5\x91\x8a=============\nversion:            V1.9.5 (11311) [\xe6\xad\xa3\xe5\xbc\x8f\xe7\x89\x88]\ndeviceType:         iPad Air (WiFi)\nIOS Ver:            iPhone OS 8.1.2\navailableMemory:    208.1MB\nusedMemory:         68.5MB\ntime:               2017-09-19_06-22-26\nnUid:               0\nsName:              \nsLinkID:            \nsBindEmail:         \nphone:              \n\nERROR: All calls to UIKit need to happen on the main thread. You have a bug in your code. Use dispatch_async(dispatch_get_main_queue(), ^{ ... }); if you\'re unsure what thread you\'re in.\n\nBreak on PSPDFAssertIfNotMainThread to find out where.\n\nStacktrace: (\n\t0   WeGamers                            0x0000000100b10f70 WeGamers + 11226992\n\t1   WeGamers                            0x0000000100b10ff0 WeGamers + 11227120\n\t2   UIKit                               0x000000018c08660c  + 184\n\t3   UIKit                               0x000000018c0de760  + 52\n\t4   UIKit                               0x000000018c0fce0c  + 92\n\t5   UIKit                               0x000000018c486f80  + 32\n\t6   UIKit                               0x000000018c0fc608  + 112\n\t7   UIKit                               0x000000018c486734  + 100\n\t8   UIKit                               0x000000018c0db15c  + 104\n\t9   UIKit                               0x000000018c081648  + 572\n\t10  QuartzCore                          0x000000018b9d9994  + 168\n\t11  QuartzCore                          0x000000018b9d4564  + 320\n\t12  UIKit                               0x000000018c095a2c  + 160\n\t13  UIKit                               0x000000018c4841a8  + 184\n\t14  MediaPlayer                         0x0000000189aaa2a0  + 1108\n\t15  MediaPlayer                         0x0000000189aa89d4  + 240\n\t16  MediaPlayer                         0x0000000189aa8a60  + 88\n\t17  WebCore                             0x0000000195f74684  + 132\n\t18  WebCore                             0x0000000195f73db8  + 96\n\t19  WebCore                             0x0000000195f73d28 _ZN7WebCore19MediaSessionManager13sharedManagerEv + 56\n\t20  WebCore                             0x0000000195f72890  + 44\n\t21  WebCore                             0x0000000195ab8604  + 36\n\t22  WebCore                             0x0000000195aa0fb0  + 1100\n\t23  WebCore                             0x0000000195a77fe0  + 64\n\t24  WebCore                             0x0000000195a8cecc  + 92\n\t25  WebCore                             0x0000000195a8cc8c  + 336\n\t26  WebCore                             0x00000001955dfefc  + 164\n\t27  WebCore                             0x00000001955dfcdc  + 36\n\t28  WebCore                             0x00000001955de5e0  + 1924\n\t29  WebCore                             0x00000001955dd00c  + 2496\n\t30  WebCore                             0x00000001955dc558  + 136\n\t31  WebCore                             0x00000001955dc404  + 312\n\t32  WebCore                             0x00000001955dbc2c  + 140\n\t33  WebCore                             0x00000001955c5ee4  + 384\n\t34  WebCore                             0x000000019562e820  + 428\n\t35  WebCore                             0x00000001958d9abc  + 116\n\t36  WebCore                             0x00000001955f7a58 _ZN7WebCore14DocumentLoader10commitDataEPKcm + 64\n\t37  WebKitLegacy                        0x000000019647cc80  + 140\n\t38  WebKitLegacy                        0x000000019647cb74  + 76\n\t39  WebKitLegacy                        0x000000019647cb08  + 124\n\t40  WebCore                             0x000000019562487c  + 164\n\t41  WebCore                             0x0000000195624704 _ZN7WebCore14DocumentLoader12dataReceivedEPNS_14CachedResourceEPKci + 348\n\t42  WebCore                             0x0000000195624560  + 96\n\t43  WebCore                             0x00000001956242cc  + 212\n\t44  WebCore                             0x000000019618797c  + 232\n\t45  WebCore                             0x0000000196187a58  + 56\n\t46  WebCore                             0x00000001960eab88  + 100\n\t47  WebCore                             0x0000000196237ae8  + 136\n\t48  CFNetwork                           0x0000000187248f68  + 128\n\t49  CFNetwork                           0x0000000187314540  + 104\n\t50  CFNetwork                           0x0000000187237b54  + 76\n\t51  CoreFoundation                      0x00000001877b4aac CFArrayApplyFunction + 68\n\t52  CFNetwork                           0x0000000187237a00  + 136\n\t53  CFNetwork                           0x00000001872378b4  + 312\n\t54  CFNetwork                           0x00000001872376e0  + 68\n\t55  CoreFoundation                      0x000000018788a9ec  + 24\n\t56  CoreFoundation                      0x0000000187889c90  + 264\n\t57  CoreFoundation                      0x0000000187887d40  + 712\n\t58  CoreFoundation                      0x00000001877b50a4 CFRunLoopRunSpecific + 396\n\t59  WebCore                             0x00000001955ec858  + 468\n\t60  libsystem_pthread.dylib             0x0000000198b0fe80  + 164\n\t61  libsystem_pthread.dylib             0x0000000198b0fddc  + 0\n\t62  libsystem_pthread.dylib             0x0000000198b0cfb0 thread_start + 4"}'
        # self.request_raw = b'POST / HTTP/1.1\r\ncache-control: no-cache\r\nPostman-Token: 188e7454-9e78-401e-a935-3c08b7b6591a\r\nContent-Type: text/plain\r\nUser-Agent: PostmanRuntime/6.3.2\r\nAccept: */*\r\nHost: 127.0.0.1:8000\r\naccept-encoding: gzip, deflate\r\ncontent-length: 5074\r\nConnection: keep-alive\r\n\r\n{"data":"=============\xe5\xbc\x82\xe5\xb8\xb8\xe5\xb4\xa9\xe6\xba\x83\xe6\x8a\xa5\xe5\x91\x8a=============\nversion:            V1.9.5 (11311) [\xe6\xad\xa3\xe5\xbc\x8f\xe7\x89\x88]\ndeviceType:         iPad Air (WiFi)\nIOS Ver:            iPhone OS 8.1.2\navailableMemory:    208.1MB\nusedMemory:         68.5MB\ntime:               2017-09-19_06-22-26\nnUid:               0\nsName:              \nsLinkID:            \nsBindEmail:         \nphone:              \n\nERROR: All calls to UIKit need to happen on the main thread. You have a bug in your code. Use dispatch_async(dispatch_get_main_queue(), ^{ ... }); if you\'re unsure what thread you\'re in.\n\nBreak on PSPDFAssertIfNotMainThread to find out where.\n\nStacktrace: (\n\t0   WeGamers                            0x0000000100b10f70 WeGamers + 11226992\n\t1   WeGamers                            0x0000000100b10ff0 WeGamers + 11227120\n\t2   UIKit                               0x000000018c08660c  + 184\n\t3   UIKit                               0x000000018c0de760  + 52\n\t4   UIKit                               0x000000018c0fce0c  + 92\n\t5   UIKit                               0x000000018c486f80  + 32\n\t6   UIKit                               0x000000018c0fc608  + 112\n\t7   UIKit                               0x000000018c486734  + 100\n\t8   UIKit                               0x000000018c0db15c  + 104\n\t9   UIKit                               0x000000018c081648  + 572\n\t10  QuartzCore                          0x000000018b9d9994  + 168\n\t11  QuartzCore                          0x000000018b9d4564  + 320\n\t12  UIKit                               0x000000018c095a2c  + 160\n\t13  UIKit                               0x000000018c4841a8  + 184\n\t14  MediaPlayer                         0x0000000189aaa2a0  + 1108\n\t15  MediaPlayer                         0x0000000189aa89d4  + 240\n\t16  MediaPlayer                         0x0000000189aa8a60  + 88\n\t17  WebCore                             0x0000000195f74684  + 132\n\t18  WebCore                             0x0000000195f73db8  + 96\n\t19  WebCore                             0x0000000195f73d28 _ZN7WebCore19MediaSessionManager13sharedManagerEv + 56\n\t20  WebCore                             0x0000000195f72890  + 44\n\t21  WebCore                             0x0000000195ab8604  + 36\n\t22  WebCore                             0x0000000195aa0fb0  + 1100\n\t23  WebCore                             0x0000000195a77fe0  + 64\n\t24  WebCore                             0x0000000195a8cecc  + 92\n\t25  WebCore                             0x0000000195a8cc8c  + 336\n\t26  WebCore                             0x00000001955dfefc  + 164\n\t27  WebCore                             0x00000001955dfcdc  + 36\n\t28  WebCore                             0x00000001955de5e0  + 1924\n\t29  WebCore                             0x00000001955dd00c  + 2496\n\t30  WebCore                             0x00000001955dc558  + 136\n\t31  WebCore                             0x00000001955dc404  + 312\n\t32  WebCore                             0x00000001955dbc2c  + 140\n\t33  WebCore                             0x00000001955c5ee4  + 384\n\t34  WebCore                             0x000000019562e820  + 428\n\t35  WebCore                             0x00000001958d9abc  + 116\n\t36  WebCore                             0x00000001955f7a58 _ZN7WebCore14DocumentLoader10commitDataEPKcm + 64\n\t37  WebKitLegacy                        0x000000019647cc80  + 140\n\t38  WebKitLegacy                        0x000000019647cb74  + 76\n\t39  WebKitLegacy                        0x000000019647cb08  + 124\n\t40  WebCore                             0x000000019562487c  + 164\n\t41  WebCore                             0x0000000195624704 _ZN7WebCore14DocumentLoader12dataReceivedEPNS_14CachedResourceEPKci + 348\n\t42  WebCore                             0x0000000195624560  + 96\n\t43  WebCore                             0x00000001956242cc  + 212\n\t44  WebCore                             0x000000019618797c  + 232\n\t45  WebCore                             0x0000000196187a58  + 56\n\t46  WebCore                             0x00000001960eab88  + 100\n\t47  WebCore                             0x0000000196237ae8  + 136\n\t48  CFNetwork                           0x0000000187248f68  + 128\n\t49  CFNetwork                           0x0000000187314540  + 104\n\t50  CFNetwork                           0x0000000187237b54  + 76\n\t51  CoreFoundation                      0x00000001877b4aac CFArrayApplyFunction + 68\n\t52  CFNetwork                           0x0000000187237a00  + 136\n\t53  CFNetwork                           0x00000001872378b4  + 312\n\t54  CFNetwork                           0x00000001872376e0  + 68\n\t55  CoreFoundation                      0x000000018788a9ec  + 24\n\t56  CoreFoundation                      0x0000000187889c90  + 264\n\t57  CoreFoundation                      0x0000000187887d40  + 712\n\t58  CoreFoundation                      0x00000001877b50a4 CFRunLoopRunSpecific + 396\n\t59  WebCore                             0x00000001955ec858  + 468\n\t60  libsystem_pthread.dylib             0x0000000198b0fe80  + 164\n\t61  libsystem_pthread.dylib             0x0000000198b0fddc  + 0\n\t62  libsystem_pthread.dylib             0x0000000198b0cfb0 thread_start + 4\n\t"}'
        # self.request_raw = b'POST / HTTP/1.1\r\ncache-control: no-cache\r\nPostman-Token: 188e7454-9e78-401e-a935-3c08b7b6591a\r\nContent-Type: text/plain\r\nUser-Agent: PostmanRuntime/6.3.2\r\nAccept: */*\r\nHost: 127.0.0.1:8000\r\naccept-encoding: gzip, deflate\r\ncontent-length: 5074\r\nConnection: keep-alive\r\n\r\n{"data":"=============\xe5\xbc\x82\xe5\xb8\xb8\xe5\xb4\xa9\xe6\xba\x83\xe6\x8a\xa5\xe5\x91\x8a=============\nversion:            V1.9.5 (11311) [\xe6\xad\xa3\xe5\xbc\x8f\xe7\x89\x88]\ndeviceType:         iPad Air (WiFi)\nIOS Ver:            iPhone OS 8.1.2\navailableMemory:    208.1MB\nusedMemory:         68.5MB\ntime:               2017-09-19_06-22-26\nnUid:               0\nsName:              \nsLinkID:            \nsBindEmail:         \nphone:              \n\nERROR: All calls to UIKit need to happen on the main thread. You have a bug in your code. Use dispatch_async(dispatch_get_main_queue(), ^{ ... }); if you\'re unsure what thread you\'re in.\n\nBreak on PSPDFAssertIfNotMainThread to find out where.\n\nStacktrace: (\n\t0   WeGamers                            0x0000000100b10f70 WeGamers + 11226992\n\t1   WeGamers                            0x0000000100b10ff0 WeGamers + 11227120\n\t2   UIKit                               0x000000018c08660c  + 184\n\t3   UIKit                               0x000000018c0de760  + 52\n\t4   UIKit                               0x000000018c0fce0c  + 92\n\t5   UIKit                               0x000000018c486f80  + 32\n\t6   UIKit                               0x000000018c0fc608  + 112\n\t7   UIKit                               0x000000018c486734  + 100\n\t8   UIKit                               0x000000018c0db15c  + 104\n\t9   UIKit                               0x000000018c081648  + 572\n\t10  QuartzCore                          0x000000018b9d9994  + 168\n\t11  QuartzCore                          0x000000018b9d4564  + 320\n\t12  UIKit                               0x000000018c095a2c  + 160\n\t13  UIKit                               0x000000018c4841a8  + 184\n\t14  MediaPlayer                         0x0000000189aaa2a0  + 1108\n\t15  MediaPlayer                         0x0000000189aa89d4  + 240\n\t16  MediaPlayer                         0x0000000189aa8a60  + 88\n\t17  WebCore                             0x0000000195f74684  + 132\n\t18  WebCore                             0x0000000195f73db8  + 96\n\t19  WebCore                             0x0000000195f73d28 _ZN7WebCore19MediaSessionManager13sharedManagerEv + 56\n\t20  WebCore                             0x0000000195f72890  + 44\n\t21  WebCore                             0x0000000195ab8604  + 36\n\t22  WebCore                             0x0000000195aa0fb0  + 1100\n\t23  WebCore                             0x0000000195a77fe0  + 64\n\t24  WebCore                             0x0000000195a8cecc  + 92\n\t25  WebCore                             0x0000000195a8cc8c  + 336\n\t26  WebCore                             0x00000001955dfefc  + 164\n\t27  WebCore                             0x00000001955dfcdc  + 36\n\t28  WebCore                             0x00000001955de5e0  + 1924\n\t29  WebCore                             0x00000001955dd00c  + 2496\n\t30  WebCore                             0x00000001955dc558  + 136\n\t31  WebCore                             0x00000001955dc404  + 312\n\t32  WebCore                             0x00000001955dbc2c  + 140\n\t33  WebCore                             0x00000001955c5ee4  + 384\n\t34  WebCore                             0x000000019562e820  + 428\n\t35  WebCore                             0x00000001958d9abc  + 116\n\t36  WebCore                             0x00000001955f7a58 _ZN7WebCore14DocumentLoader10commitDataEPKcm + 64\n\t37  WebKitLegacy                        0x000000019647cc80  + 140\n\t38  WebKitLegacy                        0x000000019647cb74  + 76\n\t39  WebKitLegacy                        0x000000019647cb08  + 124\n\t40  WebCore                             0x000000019562487c  + 164\n\t41  WebCore                             0x0000000195624704 _ZN7WebCore14DocumentLoader12dataReceivedEPNS_14CachedResourceEPKci + 348\n\t42  WebCore                             0x0000000195624560  + 96\n\t43  WebCore                             0x00000001956242cc  + 212\n\t44  WebCore                             0x000000019618797c  + 232\n\t45  WebCore                             0x0000000196187a58  + 56\n\t46  WebCore                             0x00000001960eab88  + 100\n\t47  WebCore                             0x0000000196237ae8  + 136\n\t48  CFNetwork                           0x0000000187248f68  + 128\n\t49  CFNetwork                           0x0000000187314540  + 104\n\t50  CFNetwork                           0x0000000187237b54  + 76\n\t51  CoreFoundation                      0x00000001877b4aac CFArrayApplyFunction + 68\n\t52  CFNetwork                           0x0000000187237a00  + 136\n\t53  CFNetwork                           0x00000001872378b4  + 312\n\t54  CFNetwork                           0x00000001872376e0  + 68\n\t55  CoreFoundation                      0x000000018788a9ec  + 24\n\t56  CoreFoundation                      0x0000000187889c90  + 264\n\t57  CoreFoundation                      0x0000000187887d40  + 712\n\t58  CoreFoundation                      0x00000001877b50a4 CFRunLoopRunSpecific + 396\n\t59  WebCore                             0x00000001955ec858  + 468\n\t60  libsystem_pthread.dylib             0x0000000198b0fe80  + 164\n\t61  libsystem_pthread.dylib             0x0000000198b0fddc  + 0\n\t62  libsystem_pthread.dylib             0x0000000198b0cfb0 thread_start + 4"}POST / HTTP/1.1\r\ncache-control: no-cache\r\nPostman-Token: f9da1fb9-21b5-48d5-9885-6e8684f727d4\r\nContent-Type: text/plain\r\nUser-Agent: PostmanRuntime/6.3.2\r\nAccept: */*\r\nHost: 127.0.0.1:8000\r\naccept-encoding: gzip, deflate\r\ncontent-length: 5076\r\nConnection: keep-alive\r\n\r\n{"data":"=============\xe5\xbc\x82\xe5\xb8\xb8\xe5\xb4\xa9\xe6\xba\x83\xe6\x8a\xa5\xe5\x91\x8a=============\nversion:            V1.9.5 (11311) [\xe6\xad\xa3\xe5\xbc\x8f\xe7\x89\x88]\ndeviceType:         iPad Air (WiFi)\nIOS Ver:            iPhone OS 8.1.2\navailableMemory:    208.1MB\nusedMemory:         68.5MB\ntime:               2017-09-19_06-22-26\nnUid:               0\nsName:              \nsLinkID:            \nsBindEmail:         \nphone:              \n\nERROR: All calls to UIKit need to happen on the main thread. You have a bug in your code. Use dispatch_async(dispatch_get_main_queue(), ^{ ... }); if you\'re unsure what thread you\'re in.\n\nBreak on PSPDFAssertIfNotMainThread to find out where.\n\nStacktrace: (\n\t0   WeGamers                            0x0000000100b10f70 WeGamers + 11226992\n\t1   WeGamers                            0x0000000100b10ff0 WeGamers + 11227120\n\t2   UIKit                               0x000000018c08660c  + 184\n\t3   UIKit                               0x000000018c0de760  + 52\n\t4   UIKit                               0x000000018c0fce0c  + 92\n\t5   UIKit                               0x000000018c486f80  + 32\n\t6   UIKit                               0x000000018c0fc608  + 112\n\t7   UIKit                               0x000000018c486734  + 100\n\t8   UIKit                               0x000000018c0db15c  + 104\n\t9   UIKit                               0x000000018c081648  + 572\n\t10  QuartzCore                          0x000000018b9d9994  + 168\n\t11  QuartzCore                          0x000000018b9d4564  + 320\n\t12  UIKit                               0x000000018c095a2c  + 160\n\t13  UIKit                               0x000000018c4841a8  + 184\n\t14  MediaPlayer                         0x0000000189aaa2a0  + 1108\n\t15  MediaPlayer                         0x0000000189aa89d4  + 240\n\t16  MediaPlayer                         0x0000000189aa8a60  + 88\n\t17  WebCore                             0x0000000195f74684  + 132\n\t18  WebCore                             0x0000000195f73db8  + 96\n\t19  WebCore                             0x0000000195f73d28 _ZN7WebCore19MediaSessionManager13sharedManagerEv + 56\n\t20  WebCore                             0x0000000195f72890  + 44\n\t21  WebCore                             0x0000000195ab8604  + 36\n\t22  WebCore                             0x0000000195aa0fb0  + 1100\n\t23  WebCore                             0x0000000195a77fe0  + 64\n\t24  WebCore                             0x0000000195a8cecc  + 92\n\t25  WebCore                             0x0000000195a8cc8c  + 336\n\t26  WebCore                             0x00000001955dfefc  + 164\n\t27  WebCore                             0x00000001955dfcdc  + 36\n\t28  WebCore                             0x00000001955de5e0  + 1924\n\t29  WebCore                             0x00000001955dd00c  + 2496\n\t30  WebCore                             0x00000001955dc558  + 136\n\t31  WebCore                             0x00000001955dc404  + 312\n\t32  WebCore                             0x00000001955dbc2c  + 140\n\t33  WebCore                             0x00000001955c5ee4  + 384\n\t34  WebCore                             0x000000019562e820  + 428\n\t35  WebCore                             0x00000001958d9abc  + 116\n\t36  WebCore                             0x00000001955f7a58 _ZN7WebCore14DocumentLoader10commitDataEPKcm + 64\n\t37  WebKitLegacy                        0x000000019647cc80  + 140\n\t38  WebKitLegacy                        0x000000019647cb74  + 76\n\t39  WebKitLegacy                        0x000000019647cb08  + 124\n\t40  WebCore                             0x000000019562487c  + 164\n\t41  WebCore                             0x0000000195624704 _ZN7WebCore14DocumentLoader12dataReceivedEPNS_14CachedResourceEPKci + 348\n\t42  WebCore                             0x0000000195624560  + 96\n\t43  WebCore                             0x00000001956242cc  + 212\n\t44  WebCore                             0x000000019618797c  + 232\n\t45  WebCore                             0x0000000196187a58  + 56\n\t46  WebCore                             0x00000001960eab88  + 100\n\t47  WebCore                             0x0000000196237ae8  + 136\n\t48  CFNetwork                           0x0000000187248f68  + 128\n\t49  CFNetwork                           0x0000000187314540  + 104\n\t50  CFNetwork                           0x0000000187237b54  + 76\n\t51  CoreFoundation                      0x00000001877b4aac CFArrayApplyFunction + 68\n\t52  CFNetwork                           0x0000000187237a00  + 136\n\t53  CFNetwork                           0x00000001872378b4  + 312\n\t54  CFNetwork                           0x00000001872376e0  + 68\n\t55  CoreFoundation                      0x000000018788a9ec  + 24\n\t56  CoreFoundation                      0x0000000187889c90  + 264\n\t57  CoreFoundation                      0x0000000187887d40  + 712\n\t58  CoreFoundation                      0x00000001877b50a4 CFRunLoopRunSpecific + 396\n\t59  WebCore                             0x00000001955ec858  + 468\n\t60  libsystem_pthread.dylib             0x0000000198b0fe80  + 164\n\t61  libsystem_pthread.dylib             0x0000000198b0fddc  + 0\n\t62  libsystem_pthread.dylib             0x0000000198b0cfb0 thread_start + 4\n\t"}POST / HTTP/1.1\r\ncache-control: no-cache\r\nPostman-Token: 390e5372-9977-4ec2-a4d5-5bb42359ae83\r\nContent-Type: text/plain\r\nUser-Agent: PostmanRuntime/6.3.2\r\nAccept: */*\r\nHost: 127.0.0.1:8000\r\naccept-encoding: gzip, deflate\r\ncontent-length: 2149\r\nConnection: keep-alive\r\n\r\n{"data":"=============\xe5\xbc\x82\xe5\xb8\xb8\xe5\xb4\xa9\xe6\xba\x83\xe6\x8a\xa5\xe5\x91\x8a=============\nversion:            V1.9.5 (11311) [\xe6\xad\xa3\xe5\xbc\x8f\xe7\x89\x88]\ndeviceType:         iPad Air (WiFi)\nIOS Ver:            iOS 10.2.1\navailableMemory:    685.5MB\nusedMemory:         88.5MB\ntime:               2017-09-17_13-39-19\nnUid:               2006336990\nsName:              U6336990\nsLinkID:            a1470018341\nsBindEmail:         1470018341@qq.com\nphone:              \nname:              NSGenericException\nreason:             *** Collection <__NSArrayM: 0x170e5a2e0> was mutated while being enumerated.\n\ncallStackSymbols:\n0   CoreFoundation                      0x000000018a67d1d0  + 148\n1   libobjc.A.dylib                     0x00000001890b455c objc_exception_throw + 56\n2   CoreFoundation                      0x000000018a67cc00  + 0\n3   WeGamers                            0x00000001012662f0 WeGamers + 18391792\n4   WeGamers                            0x00000001012660dc WeGamers + 18391260\n5   WeGamers                            0x000000010049ddf0 WeGamers + 3939824\n6   WeGamers                            0x000000010049720c WeGamers + 3912204\n7   CoreFoundation                      0x000000018a616b10  + 20\n8   CoreFoundation                      0x000000018a616214  + 400\n9   CoreFoundation                      0x000000018a615f90  + 60\n10  CoreFoundation                      0x000000018a685b8c  + 1504\n11  CoreFoundation                      0x000000018a557e64 _CFXNotificationPost + 376\n12  Foundation                          0x000000018b08ce0c  + 68\n13  WeGamers                            0x000000010129dd74 WeGamers + 18619764\n14  libdispatch.dylib                   0x00000001895061fc  + 24\n15  libdispatch.dylib                   0x00000001895061bc  + 16\n16  libdispatch.dylib                   0x00000001895143dc  + 928\n17  libdispatch.dylib                   0x00000001895099a4  + 652\n18  libdispatch.dylib                   0x000000018951634c  + 572\n19  libdispatch.dylib                   0x00000001895160ac  + 124\n20  libsystem_pthread.dylib             0x000000018970f2a0 _pthread_wqthread + 1288\n21  libsystem_pthread.dylib             0x000000018970ed8c start_wqthread + 4\n\t"}POST / HTTP/1.1\r\ncache-control: no-cache\r\nPostman-Token: 16a4188e-4960-4f6f-a229-1f7077402325\r\nContent-Type: text/plain\r\nUser-Agent: PostmanRuntime/6.3.2\r\nAccept: */*\r\nHost: 127.0.0.1:8000\r\naccept-encoding: gzip, deflate\r\ncontent-length: 2149\r\nConnection: keep-alive\r\n\r\n{"data":"=============\xe5\xbc\x82\xe5\xb8\xb8\xe5\xb4\xa9\xe6\xba\x83\xe6\x8a\xa5\xe5\x91\x8a=============\nversion:            V1.9.5 (11311) [\xe6\xad\xa3\xe5\xbc\x8f\xe7\x89\x88]\ndeviceType:         iPad Air (WiFi)\nIOS Ver:            iOS 10.2.1\navailableMemory:    685.5MB\nusedMemory:         88.5MB\ntime:               2017-09-17_13-39-19\nnUid:               2006336990\nsName:              U6336990\nsLinkID:            a1470018341\nsBindEmail:         1470018341@qq.com\nphone:              \nname:              NSGenericException\nreason:             *** Collection <__NSArrayM: 0x170e5a2e0> was mutated while being enumerated.\n\ncallStackSymbols:\n0   CoreFoundation                      0x000000018a67d1d0  + 148\n1   libobjc.A.dylib                     0x00000001890b455c objc_exception_throw + 56\n2   CoreFoundation                      0x000000018a67cc00  + 0\n3   WeGamers                            0x00000001012662f0 WeGamers + 18391792\n4   WeGamers                            0x00000001012660dc WeGamers + 18391260\n5   WeGamers                            0x000000010049ddf0 WeGamers + 3939824\n6   WeGamers                            0x000000010049720c WeGamers + 3912204\n7   CoreFoundation                      0x000000018a616b10  + 20\n8   CoreFoundation                      0x000000018a616214  + 400\n9   CoreFoundation                      0x000000018a615f90  + 60\n10  CoreFoundation                      0x000000018a685b8c  + 1504\n11  CoreFoundation                      0x000000018a557e64 _CFXNotificationPost + 376\n12  Foundation                          0x000000018b08ce0c  + 68\n13  WeGamers                            0x000000010129dd74 WeGamers + 18619764\n14  libdispatch.dylib                   0x00000001895061fc  + 24\n15  libdispatch.dylib                   0x00000001895061bc  + 16\n16  libdispatch.dylib                   0x00000001895143dc  + 928\n17  libdispatch.dylib                   0x00000001895099a4  + 652\n18  libdispatch.dylib                   0x000000018951634c  + 572\n19  libdispatch.dylib                   0x00000001895160ac  + 124\n20  libsystem_pthread.dylib             0x000000018970f2a0 _pthread_wqthread + 1288\n21  libsystem_pthread.dylib             0x000000018970ed8c start_wqthread + 4\n\t"}'

    # Split request raw data to get the request body
    def get_crash_info_raw(self):
        request_data = self.request_raw.decode().split('\r\n\r\n')
        return request_data[-1]

    # Split request body to get crash information list
    def get_crash_info(self, pkgname):

        data = self.get_crash_info_raw()
        # Get application name
        for k,v in enumerate(pkgname):
            if v in data:
                self.cur_app_name = k
        # Split '\n' to get lines
        self.data_lines = data.split('\n')
        # Remove first and last one. These was the json indicator.
        # Because i can not transfer the bytes to json now.. maybe later can..
        del self.data_lines[0]
        del self.data_lines[-1]
        # Get the count number of the Stacktrace list items
        self.nStacktrace_max = int(self.data_lines[-1].split()[0]) + 1

    def get_env_info(self):
        # Complier regular expression
        ver = re.compile(r'\d+(\.\d+){0,2}')    # version code
        biu = re.compile(r'[\d]+')              # Consecutive numbers
        typ = re.compile(r'[\u4e00-\u9fa5]+')
        for i in self.data_lines:
            if 'version' in i:
                version_code = ver.search(i)
                build_number = biu.findall(i)
                if typ.findall(i)[0] == '正式版':
                    print('正式版', typ.findall(i))
                    version_type = 'appstore'
                else:
                    print('dev版', typ.findall(i))
                    version_type = 'dev'
                return [version_code.group(0), build_number[-1], version_type]

    def is_32bit(self):
        if len(self.data_lines[-5].split()[2]) == 10:

            return 'armv7'
        else:
            return 'arm64'

    # Get Stacktrac list and seqencing.
    def get_crash_list(self):
        for i in range(1, self.nStacktrace_max):
            # Get lines negative number.
            _index = i - i * 2
            # Get list data by reverstion.
            self.stacktrac_list.append(self.data_lines[_index].split())

    def call_atos(self, dSYM_file, product_name, proc):
        atos = 'atos'
        arch = '-arch'
        op = '-o'
        _l = '-l'
        app_symbol = dSYM_file + '/Contents/Resources/DWARF/%s' % product_name
        print('app_symbol', app_symbol)
        self.addr_list(produce_name=product_name)
        cpu_arm_ = self.is_32bit()
        print('parse_line', self.parse_lines)
        for _index, _value in enumerate(self.parse_lines):
            print('enumerate', _index, _value)
            base_addr = _value[-1]
            memory_addr = _value[-2]
            atos_cmd = ' '.join([atos, arch, cpu_arm_, op, app_symbol, _l, base_addr, memory_addr])
            print(atos_cmd)
            parse_result = self.proc.sub_procs_run(cmd=atos_cmd)
            result = parse_result.stdout.decode()
            target_line = (_index + 1) - 2*(_index+1)
            print('target_line', target_line)
            raw_data = self.data_lines[target_line].split()
            print('raw_data', raw_data)
            replace_data = '    '.join([_value[0], raw_data[2], result])
            print('replace_data', replace_data)
            self.data_lines[target_line] = replace_data
        print('data_lines', self.data_lines)

    def addr_list(self, produce_name):
        self.get_crash_list()
        print('self.stacktrac_list', self.stacktrac_list)
        for key, line in enumerate(self.stacktrac_list):
            print('enumerate(self.stacktrac_list', key, line)

            if produce_name in line:
                _memory_addr_start = hex(
                    int('%s' % line[2], 16) - int(line[-1]))
                _memory_addr_stack = line[2]
                less_line = [line[0], _memory_addr_stack, _memory_addr_start]
                self.parse_lines.append(less_line)
